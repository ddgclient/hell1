# This is a basic workflow to help you get started with Actions
name: CI
env:
  TARGET: "All"
  pValPath: .\pipeline_scripts\pVal\PrimeValTool.exe
  tosPath: C:\intel\hdmt\hdmtOS_3.10.0.0_Release
  #wiki_authkey: ${{secrets.WIKI_AUTHKEY}}

on: 
  push:
    branches: 
     - '**'

concurrency: 
  group: tos-validation

jobs:
  Compile:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - name: Compile code
        uses: ./.github/actions/compile
        timeout-minutes: 10
        #max_attempts: 3, not supported, look into workflow: https://hsalem.com/posts/ability-to-rerun-single-jobs-in-github-actions.html
        continue-on-error: false

  UnitTest:
    needs: Compile
    runs-on: self-hosted
    steps:
     - name: Run Unit Tests
       run: .\pipeline_scripts\RunUnitTests.cmd -ci $env:GITHUB_WORKSPACE

  CheckCoverage:
    needs: UnitTest
    runs-on: self-hosted
    steps:
      - name: Run coverage analysis
        uses: ./.github/actions/coverage
        timeout-minutes: 10
        continue-on-error: true

      - name: 'Upload Artifact'
        uses: actions/upload-artifact@v3
        with:
          name: my-artifact
          path: .\logs
          retention-days: 7
         
  PrimeValidation:
    needs: CheckCoverage
    runs-on: self-hosted
    steps:
      - name: List mapped drives
        run:  net use
      - name: Map I:drive 
        run:  'net use I: \\amr.corp.intel.com\ec\proj\mdl\jf\intel /y ; $LASTEXITCODE= 0'
      - name: Run pVal
        run:  powershell $env:pValPath $env:tosPath full -sk
 #   with:
 #     name: my-artifact
 #     path: 
 #       .\logs
 #       .\pVal
 #     retention-days: 3         
 #    #allow_failure: false    
         
  Release:
    needs: PrimeValidation
    runs-on: self-hosted
    steps:
      - name: Run Release
        uses: ./.github/actions/release
        timeout-minutes: 10
        continue-on-error: true

      - name: 'Upload Artifact'
        uses: actions/upload-artifact@v3
        with:
          authkey: ${{secrets.WIKI_AUTHKEY}}
          name: my-artifact
          path: .\
          retention-days: 7



















         
